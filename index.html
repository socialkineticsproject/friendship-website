<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Friendship Universe â€” Premium</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
Â  /* ---------- THEME & LAYOUT ---------- */
Â  :root{
Â  Â  --bg:#07070a; --card:#0f1113; --muted:#bfc7ce;
Â  Â  --neon1:#6ef0b6; --neon2:#7bd0ff; --accent:#83f07a;
Â  Â  --glass: rgba(255,255,255,0.03);
Â  }
Â  [data-theme="light"]{
Â  Â  --bg:#f4f7fb; --card:#ffffff; --muted:#475569;
Â  Â  --neon1:#0ea5a4; --neon2:#06b6d4; --accent:#0ea5a4;
Â  }
Â  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color: #e6eef3}
Â  body{background: radial-gradient(800px 400px at 10% 20%, rgba(123,208,255,0.03), transparent 8%), var(--bg); display:flex; gap:18px; padding:18px; align-items:flex-start; justify-content:center; overflow:hidden;}

Â  /* Container / Card */
Â  .card{width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02);backdrop-filter: blur(6px)}
Â  h1{margin:0 0 6px;font-size:20px}
Â  .muted{color:var(--muted);font-size:13px}

Â  input, textarea, button, select { width:100%; padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03); background: rgba(12,12,14,0.65); color:inherit; font-size:14px; box-sizing:border-box; }
Â  textarea{min-height:86px; resize:vertical}
Â  .row{display:flex;gap:10px}
Â  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
Â  .btn-primary{background:linear-gradient(90deg,var(--neon1),var(--neon2)); color:#05110a; box-shadow: 0 8px 30px rgba(110,240,182,0.06)}
Â  .btn-ghost{background:rgba(255,255,255,0.03); color:var(--muted)}
Â  .small{padding:8px 10px;font-size:13px}
Â  .socialProof{color:var(--neon1); font-weight:700; margin-top:8px; font-size:13px}
Â  .muteline{color:var(--muted); font-size:13px}

Â  /* map */
Â  #mapWrap{width:760px; height:620px;border-radius:12px; overflow:hidden;border:1px solid rgba(255,255,255,0.02); background:#020202}
Â  .mapHeader{padding:12px 16px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); background:rgba(255,255,255,0.01)}
Â  #map{height:calc(100% - 52px)}

Â  /* timeline */
Â  .timeline{position:fixed; right:18px; bottom:18px; width:320px; background:rgba(8,8,10,0.9); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 10px 40px rgba(0,0,0,0.6); transform:translateY(140%); transition:transform .4s}
Â  .timeline.show{transform:translateY(0%)}
Â  .timeline .step{padding:8px;border-radius:8px;margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01),transparent)}

Â  /* small UI */
Â  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#ffd46b,#ff8a65);color:#111;font-weight:800;margin-left:8px;font-size:13px}
Â  #loading{display:none;margin:12px auto;border-radius:50%;width:44px;height:44px;border:6px solid rgba(255,255,255,0.06); border-top-color:var(--neon1); animation:spin .9s linear infinite}
Â  @keyframes spin{to{transform:rotate(360deg)}}

Â  /* profile card canvas preview */
Â  #profilePreview{width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(255,255,255,0.02));padding:8px;text-align:center;margin-top:10px}

Â  /* particle canvases */
Â  #particles, #stars {position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1;opacity:0.9}

Â  /* responsiveness */
Â  @media (max-width:1100px){
Â  Â  body{flex-direction:column;align-items:center;padding:12px}
Â  Â  #mapWrap{width:100%; height:520px}
Â  Â  .card{width:100%; max-width:760px}
Â  }
</style>
</head>
<body data-theme="dark">

<canvas id="particles"></canvas>
<canvas id="stars"></canvas>

<div class="card" id="formCard" role="region" aria-label="Friendship Form">
Â  <h1>Friendship Universe â¤ï¸ <span class="muted">â€” share a memory</span></h1>
Â  <div id="locationMsg" class="muted">Enable location to unlock map features & local stats</div>

Â  <div style="margin-top:10px;display:flex;gap:8px">
Â  Â  <button id="detectBtn" class="btn btn-ghost small">ğŸ“ Detect my city</button>
Â  Â  <button id="themeToggle" class="btn btn-ghost small">ğŸŒ— Toggle Theme</button>
Â  Â  <button id="musicToggle" class="btn btn-ghost small">ğŸ”Š Music</button>
Â  </div>

Â  <form id="friendForm" style="margin-top:12px">
Â  Â  <div class="field"><input id="yourName" placeholder="Your name or nickname" required></div>
Â  Â  <div class="row"><input id="metAt" placeholder="Where did we meet?" required><input id="duration" placeholder="How long friends? e.g., 3 years" required></div>
Â  Â  <div class="field"><textarea id="feelings" placeholder="Write a memory or feelings..." required></textarea></div>

Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  <button id="submitBtn" class="btn btn-primary" type="submit">Share memory â¤ï¸</button>
Â  Â  Â  <button id="shareBtn" type="button" class="btn btn-ghost">Share page</button>
Â  Â  </div>

Â  Â  <div id="loading"></div>

Â  Â  <div id="socialProof" class="socialProof">â€”</div>

Â  Â  <div id="scoreLine" class="muteline" style="margin-top:8px">Friendship score: <strong id="scoreVal">â€”</strong> <span id="badgeSlot"></span></div>

Â  Â  Â  Â  <div id="profilePreview" aria-hidden="false">
Â  Â  Â  <canvas id="cardCanvas" width="380" height="160" style="max-width:100%"></canvas>
Â  Â  Â  <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
Â  Â  Â  Â  <button id="downloadCard" class="btn btn-ghost small">Download Profile Card</button>
Â  Â  Â  Â  <div id="qrcode" style="background:#fff;padding:6px;border-radius:6px"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </form>
</div>

<div id="mapWrap">
Â  <div class="mapHeader">
Â  Â  <div>
Â  Â  Â  <strong>Friendship Map</strong>
Â  Â  Â  <div id="mapSub" class="muteline">Live submissions & Universe view</div>
Â  Â  </div>
Â  Â  <div style="text-align:right">
Â  Â  Â  <div class="muteline">Total memories: <strong id="totalCount">0</strong></div>
Â  Â  Â  <div class="muteline">From your city: <strong id="cityCount">0</strong></div>
Â  Â  </div>
Â  </div>
Â  <div id="map"></div>

Â  Â  <div style="position:absolute;left:12px;top:12px;z-index:40">
Â  Â  <button id="recenterBtn" class="btn btn-ghost small">Recenter</button>
Â  Â  <button id="refreshBtn" class="btn btn-ghost small">Refresh</button>
Â  </div>
</div>

<div id="timeline" class="timeline" aria-live="polite">
Â  <h3>Memory Timeline</h3>
Â  <div id="timelineContent"><div class="muteline">No recent activity</div></div>
</div>

<audio id="bgMusic" loop crossorigin="anonymous">
Â  Â  <source src="MUSIC_URL_HERE" type="audio/mpeg">
Â  Your browser doesn't support the audio element.
</audio>

<script>
/* ======================
Â  Â CONFIG - change these
Â  Â ====================== */
const G_SCRIPT = "https://script.google.com/macros/s/AKfycbz_Xu0Tqbfqt8Bbj3MDcSBBh_dXtxsZxoL1YHSIdtsl6mab3Z8Pj1b6HHBhjjdoe3VG/exec"; // <<-- REPLACE with your deployed Apps Script URL
const MUSIC_URL = "MUSIC_URL_HERE"; // REPLACE or leave as-is (blank)
const SITE_URL = window.location.href;

/* ======================
Â  Â UI refs & globals
Â  Â ====================== */
const detectBtn = document.getElementById('detectBtn');
const locationMsg = document.getElementById('locationMsg');
const socialProof = document.getElementById('socialProof');
const scoreVal = document.getElementById('scoreVal');
const badgeSlot = document.getElementById('badgeSlot');
const loadingEl = document.getElementById('loading');
const shareBtn = document.getElementById('shareBtn');
const submitBtn = document.getElementById('submitBtn');
const timelinePanel = document.getElementById('timeline');
const timelineContent = document.getElementById('timelineContent');
const totalCountEl = document.getElementById('totalCount');
const cityCountEl = document.getElementById('cityCount');
const cardCanvas = document.getElementById('cardCanvas');
const downloadCard = document.getElementById('downloadCard');
const qrcodeEl = document.getElementById('qrcode');
const themeToggle = document.getElementById('themeToggle');
const musicToggle = document.getElementById('musicToggle');
const bgMusic = document.getElementById('bgMusic');

let userLat="", userLon="", userCity="";
let map, markersGroup;
let universeOn = true;
let submissionsCache = []; // <-- Cached data for efficient star remapping

/* ======================
Â  Â Map init (Leaflet)
Â  Â ====================== */
map = L.map('map', { zoomControl:true }).setView([20,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
markersGroup = L.layerGroup().addTo(map);

const glowIcon = L.divIcon({className:'', html:`<div style="width:12px;height:12px;border-radius:50%;background:radial-gradient(circle,#7bd0ff,#4ecf9a);box-shadow:0 0 10px rgba(123,208,255,0.6)"></div>`, iconSize:[12,12]});

/* ======================
Â  Â Small helpers
Â  Â ====================== */
function safeNum(n){const x=parseFloat(n);return isNaN(x)?0:x;}
function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function shorten(s,n=120){if(!s) return ''; return s.length>n? s.slice(0,n-1)+'â€¦' : s;}
function showLoading(v){loadingEl.style.display = v? 'block' : 'none';}

/* ======================
Â  Â Load submissions (GET) - DATA FETCH
Â  Â ====================== */
async function loadSubmissions(){
Â  try{
Â  Â  const res = await fetch(`${G_SCRIPT}?mode=GET`);
Â  Â  const data = await res.json();
Â  Â  submissionsCache = data; // Update the global cache
Â  Â  markersGroup.clearLayers();
Â  Â  let total=0, cityCount=0;
Â  Â  data.forEach(e=>{
Â  Â  Â  total++;
Â  Â  Â  const lat = safeNum(e.latitude), lon=safeNum(e.longitude);
Â  Â  Â  const city = (e.city||'').toString();
Â  Â  Â  if(userCity && city && city.toLowerCase() === userCity.toLowerCase()) cityCount++;
Â  Â  Â  if(lat && lon){
Â  Â  Â  Â  const popupHtml = createPopupCard(e);
Â  Â  Â  Â  L.marker([lat,lon], {icon: glowIcon}).addTo(markersGroup).bindPopup(popupHtml,{maxWidth:320});
Â  Â  Â  }
Â  Â  });
Â  Â  totalCountEl.textContent = total;
Â  Â  cityCountEl.textContent = cityCount;
Â  Â  if(userCity) socialProof.innerHTML = `ğŸ”¥ <strong>${cityCount}</strong> friends from <strong>${escapeHtml(userCity)}</strong> have shared memories â€” add yours!`;
Â  Â  else socialProof.textContent = "Be the first from your city â€” allow location to see more!";
Â  Â  
Â  Â  // Update star coordinates after new data is loaded
Â  Â  updateMapStars(data);
Â  }catch(err){
Â  Â  console.error("loadSubmissions failed", err);
Â  Â  socialProof.textContent = "Could not load live data. Check backend & CORS.";
Â  }
}

/* ======================
Â  Â Popup card (map)
Â  Â ====================== */
function createPopupCard(entry){
Â  const name = escapeHtml(entry.name||'Anonymous');
Â  const city = escapeHtml(entry.city || entry.met || '');
Â  const feel = escapeHtml(entry.feelings||'');
Â  const when = entry.timestamp? new Date(entry.timestamp).toLocaleString() : '';
Â  return `<div style="width:260px;padding:10px;border-radius:12px;background:linear-gradient(180deg,#0b0b0d,#121214);color:#eaf7ee;border:1px solid rgba(123,208,255,0.06);box-shadow:0 8px 24px rgba(0,0,0,0.6)">
Â  Â  <div style="font-weight:800;color:var(--neon2);">${name}</div>
Â  Â  <div style="font-size:12px;color:var(--muted);margin:6px 0">${city} ${when? ' â€¢ '+when: ''}</div>
Â  Â  <div style="font-size:13px;color:#d9f7e6">${shorten(feel,220)}</div>
Â  Â  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
Â  Â  Â  <button style="padding:6px 8px;border-radius:8px;border:none;background:linear-gradient(90deg,#ff8a65,#ffd46b);font-weight:800;cursor:pointer">â¤ï¸</button>
Â  Â  Â  <button style="padding:6px 8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer">ğŸ˜Š</button>
Â  Â  </div>
Â  </div>`;
}

/* ======================
Â  Â Detect Location & reverse geocode
Â  Â ====================== */
async function detectLocation(showPrompt=true){
Â  if(!navigator.geolocation){ locationMsg.textContent = "Geolocation not supported"; return; }
Â  if(showPrompt) locationMsg.textContent = "Requesting location (browser prompt)â€¦";
Â  navigator.geolocation.getCurrentPosition(async pos=>{
Â  Â  userLat = pos.coords.latitude; userLon = pos.coords.longitude;
Â  Â  locationMsg.textContent = "Thanks for allowing location! ğŸ‰";
Â  Â  try{
Â  Â  Â  const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${userLat}&lon=${userLon}`);
Â  Â  Â  const json = await r.json();
Â  Â  Â  userCity = json.address.city || json.address.town || json.address.village || json.address.county || '';
Â  Â  Â  if(userCity) locationMsg.innerHTML = `You're in <strong>${escapeHtml(userCity)}</strong>. Share your memory!`;
Â  Â  Â  else locationMsg.textContent = "Location detected (city not found).";
Â  Â  Â  const marker = L.marker([userLat,userLon], {icon: glowIcon}).addTo(markersGroup);
Â  Â  Â  marker.bindPopup(`You are here: ${escapeHtml(userCity||'Your location')}`).openPopup();
Â  Â  Â  map.setView([userLat,userLon], Math.max(5, userCity?6:4));
Â  Â  Â  await loadSubmissions();
Â  Â  }catch(e){
Â  Â  Â  console.warn("reverse failed", e);
Â  Â  Â  locationMsg.textContent = "Location detected; reverse lookup failed.";
Â  Â  }
Â  }, err=>{
Â  Â  console.warn(err);
Â  Â  locationMsg.textContent = "Location not enabled. You can still submit!";
Â  }, { timeout:10000 });
}

/* ======================
Â  Â Scoring / AI heuristics
Â  Â ====================== */
function computeScore(durationText, feelingsText){
Â  // parse numeric time (prioritize years)
Â  let years = 0;
Â  if(durationText){
Â  Â  const txt = durationText.toLowerCase();
Â  Â  const m = txt.match(/(\d+(\.\d+)?)/);
Â  Â  if(m){ const n = parseFloat(m[1]); years = txt.includes('month')? n/12 : n; }
Â  Â  else { if(txt.includes('few')) years = 0.5; }
Â  }
Â  // length and positivity score
Â  const lenScore = Math.min(20, (feelingsText||'').length / 5); // up to 20
Â  const posWords = ['love','best','always','forever','amazing','great','awesome','closest','sweet','happy','care','cherish','grateful','thank'];
Â  const negWords = ['hate','never','angry','sad','boring','bad','distant','left','lost'];
Â  const low = (feelingsText||'').toLowerCase();
Â  let pos=0, neg=0;
Â  posWords.forEach(w=>{ if(low.includes(w)) pos++ });
Â  negWords.forEach(w=>{ if(low.includes(w)) neg++ });
Â  const sentiment = Math.max(0, pos - neg);
Â  // final composite
Â  let score = Math.round(Math.min(100, years*12 + lenScore + sentiment*8 + Math.min(15, pos*3)));
Â  return {score, years, pos, neg};
}
function pickBadge(score, years){
Â  if(score >= 85 || years >= 10) return "Legendary Friend";
Â  if(score >= 65 || years >= 5) return "Golden Friend";
Â  if(score >= 45 || years >= 2) return "Solid Buddy";
Â  if(score >= 25) return "Nice Pal";
Â  return "New Companion";
}

/* ======================
Â  Â Form submit
Â  Â ====================== */
document.getElementById('friendForm').addEventListener('submit', async (ev)=>{
Â  ev.preventDefault();
Â  showLoading(true);

Â  // pulse effect
Â  submitBtn.classList.add('pulse');
Â  setTimeout(()=> submitBtn.classList.remove('pulse'), 800);

Â  const name = document.getElementById('yourName').value.trim();
Â  const metAt = document.getElementById('metAt').value.trim();
Â  const duration = document.getElementById('duration').value.trim();
Â  const feelings = document.getElementById('feelings').value.trim();

Â  // score & badge
Â  const result = computeScore(duration, feelings);
Â  scoreVal.textContent = result.score;
Â  const badgeText = pickBadge(result.score, result.years);
Â  badgeSlot.innerHTML = `<span class="badge">${escapeHtml(badgeText)}</span>`;

Â  // timeline quick add
Â  addTimelineEntry({name,metAt,duration,feelings,city:userCity,ts:new Date().toISOString()});

Â  const payload = { name, met:metAt, duration, feelings, latitude: userLat, longitude: userLon, city: userCity, timestamp: new Date().toISOString() };

Â  try {
Â  Â  // POST JSON
Â  Â  await fetch(G_SCRIPT, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });

Â  Â  // reload markers (updates cache and calls updateMapStars)
Â  Â  await loadSubmissions();

Â  Â  // confetti
Â  Â  confetti({ particleCount: 180, spread: 70, origin: { y: 0.6 } });

Â  Â  // build profile card and QR
Â  Â  buildProfileCard({ name, metAt, duration, feelings, badge: badgeText });
    // Re-generate QR code for the page, just in case
    qrcodeEl.innerHTML = '';
    new QRCode(qrcodeEl, { text: SITE_URL, width: 96, height: 96 });

Â  Â  showLoading(false);
Â  Â  // success microcopy
Â  Â  const successMsg = `Thanks ${name}! Your memory is live.`;Â 
Â  Â  alert(successMsg);
Â  } catch(err){
Â  Â  console.error("submit error", err);
Â  Â  showLoading(false);
Â  Â  alert("Submit failed â€” check Apps Script and CORS.");
Â  }

Â  // reset form fields (keep city & starfield)
Â  document.getElementById('friendForm').reset();
});

/* ======================
Â  Â Timeline
Â  Â ====================== */
function addTimelineEntry(item){
Â  const el = document.createElement('div');
Â  el.className = 'step';
Â  const when = new Date(item.ts).toLocaleString();
Â  el.innerHTML = `<strong>${escapeHtml(item.name||'Anonymous')}</strong> â€” ${escapeHtml(item.metAt||item.city||'Unknown place')} <div class="muteline" style="margin-top:6px">${shorten(escapeHtml(item.feelings||''),120)}</div><div class="muteline" style="margin-top:6px;font-size:12px">${when}</div>`;
Â  timelineContent.prepend(el);
Â  timelinePanel.classList.add('show');
Â  setTimeout(()=> timelinePanel.classList.remove('show'), 9000);
}

/* ======================
Â  Â Starfield & particles (X-Factors)
Â  Â ====================== */
const starsCanvas = document.getElementById('stars'), sp = starsCanvas.getContext('2d');
const particleCanvas = document.getElementById('particles'), pp = particleCanvas.getContext('2d');
let W = innerWidth, H = innerHeight;
function resizeCanvases(){ W = innerWidth; H = innerHeight; starsCanvas.width=W; starsCanvas.height=H; particleCanvas.width=W; particleCanvas.height=H; }
window.addEventListener('resize', resizeCanvases);
resizeCanvases();

const particles = [];
for(let i=0;i<80;i++) particles.push({x:Math.random()*W,y:Math.random()*H, vx:(Math.random()-0.5)*0.4, vy:(Math.random()-0.5)*0.4, r:Math.random()*2+0.6, life:Math.random()*100});

let mouse={x:-9999,y:-9999}; window.addEventListener('mousemove', e=>{ mouse.x=e.clientX; mouse.y=e.clientY; });

function drawParticles(){
Â  pp.clearRect(0,0,W,H);
Â  for(const p of particles){
Â  Â  p.x += p.vx; p.y += p.vy; p.life -= 0.02;
Â  Â  const dx = mouse.x - p.x, dy = mouse.y - p.y, dist = Math.sqrt(dx*dx+dy*dy);
Â  Â  if(dist < 160 && dist>0){ p.x += dx*0.002; p.y += dy*0.002; }
Â  Â  if(p.x<0) p.x=W; if(p.x>W) p.x=0; if(p.y<0) p.y=H; if(p.y>H) p.y=0;
Â  Â  pp.beginPath(); pp.fillStyle='rgba(120,210,255,0.75)'; pp.globalAlpha = 0.25 + Math.abs(Math.sin(p.life))*0.75; pp.arc(p.x,p.y,p.r,0,Math.PI*2); pp.fill();
Â  }
Â  pp.globalAlpha=1;
}

let starData = [];

// REFACTORED: Only update star coordinates on screen using current map position
function updateMapStars(entries){
Â  starData = [];
Â  if (!map) return;
Â  
Â  entries.forEach(e=>{
Â  Â  const lat = safeNum(e.latitude), lon = safeNum(e.longitude);
Â  Â  if(lat && lon){
Â  Â  Â  try{
Â  Â  Â  Â  // Convert Lat/Lon to screen coordinates relative to the map container
Â  Â  Â  Â  const point = map.latLngToContainerPoint([lat,lon]);
Â  Â  Â  Â  starData.push({
Â  Â  Â  Â  Â  x: point.x + (Math.random()*40-20), // Scatter effect
Â  Â  Â  Â  Â  y: point.y + (Math.random()*40-20), // Scatter effect
Â  Â  Â  Â  Â  size: 1+Math.random()*2, 
Â  Â  Â  Â  Â  alpha: 0.8
Â  Â  Â  Â  });
Â  Â  Â  }catch(err){}
Â  Â  }
Â  });
}

function drawStars(){
Â  sp.clearRect(0,0,W,H);
Â  if(!universeOn) return;
Â  // subtle scatter
Â  for(let i=0;i<60;i++){ sp.beginPath(); const x=(i*137)%W, y=(i*97)%H; sp.globalAlpha=0.06; sp.fillStyle='#ffffff'; sp.arc(x,y,Math.random()*1.6,0,Math.PI*2); sp.fill(); }
Â  
Â  // starData on map
Â  const rect = map._container.getBoundingClientRect();
Â  starData.forEach(s=>{
Â  Â  // Convert map-relative coordinates to screen-relative coordinates
Â  Â  const vx = rect.left + s.x, vy = rect.top + s.y;
Â  Â  sp.beginPath(); sp.globalAlpha = s.alpha; sp.fillStyle = 'rgba(123,208,255,0.9)'; sp.arc(vx,vy,s.size*1.6,0,Math.PI*2); sp.fill();
Â  });
}

(function animate(){ requestAnimationFrame(animate); drawParticles(); drawStars(); })();

/* ======================
Â  Â Star remapping on map move (EFFICIENT FIX)
Â  Â ====================== */
map.on('move zoom', ()=> {
    // Only re-calculate screen coordinates using the existing cached data.
    updateMapStars(submissionsCache);
});

/* ======================
Â  Â Profile card generator (canvas)
Â  Â ====================== */
function buildProfileCard({name, metAt, duration, feelings, badge}){
Â  const ctx = cardCanvas.getContext('2d');
Â  // clear
Â  ctx.clearRect(0,0,cardCanvas.width,cardCanvas.height);
Â  // background
Â  const g = ctx.createLinearGradient(0,0,cardCanvas.width,cardCanvas.height); g.addColorStop(0,'#071019'); g.addColorStop(1,'#07201a');
Â  ctx.fillStyle = g; ctx.fillRect(0,0,cardCanvas.width,cardCanvas.height);
Â  // neon border
Â  ctx.strokeStyle = 'rgba(123,208,255,0.12)'; ctx.lineWidth = 2; roundRect(ctx,4,4,cardCanvas.width-8,cardCanvas.height-8,12); ctx.stroke();
Â  // title
Â  ctx.fillStyle = '#fff'; ctx.font = '18px Poppins,sans-serif'; ctx.fillText(name || 'Anonymous', 20, 36);
Â  // badge
Â  ctx.fillStyle = '#ffd46b'; ctx.font = '12px Poppins'; ctx.fillText(badge || '', cardCanvas.width - 120, 34);
Â  // meta
Â  ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.font = '12px Poppins'; ctx.fillText(metAt || '', 20, 64);
Â  ctx.fillText(duration || '', 20, 82);
Â  // feelings block
Â  ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = '13px Poppins'; wrapText(ctx, feelings || '', 20, 110, cardCanvas.width - 120, 18);
Â  // draw avatar circle
Â  ctx.beginPath(); ctx.arc(cardCanvas.width - 50, 110, 28, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.fill();
}
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
Â  const words = text.split(' ');
Â  let line = '';
Â  for(let n=0;n<words.length;n++){
Â  Â  const testLine = line + words[n] + ' ';
Â  Â  const metrics = ctx.measureText(testLine);
Â  Â  const testWidth = metrics.width;
Â  Â  if(testWidth > maxWidth && n>0){
Â  Â  Â  ctx.fillText(line, x, y);
Â  Â  Â  line = words[n] + ' ';
Â  Â  Â  y += lineHeight;
Â  Â  } else {
Â  Â  Â  line = testLine;
Â  Â  }
Â  }
Â  ctx.fillText(line, x, y);
}
// download card
downloadCard.addEventListener('click', ()=>{
Â  const url = cardCanvas.toDataURL('image/png');
Â  const a = document.createElement('a'); a.href = url; a.download = 'friendship-card.png'; a.click();
});

/* ======================
Â  Â QR code for page share
Â  Â ====================== */
new QRCode(qrcodeEl, { text: SITE_URL, width: 96, height: 96 });

/* ======================
Â  Â Share Button
Â  Â ====================== */
shareBtn.addEventListener('click', async ()=>{
Â  const text = "I just shared a friendship memory! Join the Friendship Universe:";
Â  if(navigator.share){
Â  Â  navigator.share({ title:'Friendship Universe', text, url: SITE_URL }).catch(()=> window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + SITE_URL)}`));
Â  } else {
Â  Â  window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + SITE_URL)}`);
Â  }
});

/* ======================
Â  Â Theme toggle (persist)
Â  Â ====================== */
function setTheme(theme){ document.body.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); }
themeToggle.addEventListener('click', ()=> setTheme(document.body.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));
const saved = localStorage.getItem('theme'); if(saved) setTheme(saved); else setTheme('dark');

/* ======================
Â  Â Music toggle (bg audio)
Â  Â ====================== */
if(MUSIC_URL && MUSIC_URL !== 'MUSIC_URL_HERE'){ bgMusic.src = MUSIC_URL; }
musicToggle.addEventListener('click', ()=>{
Â  if(bgMusic.paused){ bgMusic.play().catch(()=>{}); musicToggle.textContent = 'ğŸ”ˆ Music On'; }
Â  else { bgMusic.pause(); musicToggle.textContent = 'ğŸ”‡ Music Off'; }
});

/* ======================
Â  Â Load initial data and polling
Â  Â ====================== */
loadSubmissions();
// Polling for new data every 20 seconds
setInterval(loadSubmissions, 20000);

/* ======================
Â  Â Utility helpers
Â  Â ====================== */
document.getElementById('recenterBtn').addEventListener('click', ()=> map.setView([20,0],2));
document.getElementById('refreshBtn').addEventListener('click', ()=> loadSubmissions());

/* ======================
Â  Â Initial small build of card
Â  Â ====================== */
buildProfileCard({ name:'Your Name', metAt:'Meeting place', duration:'X years', feelings:'Your memory here...', badge:'New Companion' });

</script>
</body>
</html>
